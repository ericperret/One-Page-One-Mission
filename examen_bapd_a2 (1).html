<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen Blanc BAPD A2 - Banque 90 Questions</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        header {
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        header h1 { margin: 0 0 10px 0; font-size: 1.6em; }
        header p { margin: 5px 0; opacity: 0.9; font-size: 0.95em; }
        .info-box {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2d5a87;
        }
        .timer {
            background: #1e3a5f;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }
        .timer.warning { background: #e74c3c; }
        .question {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 8px;
        }
        .question-number {
            background: #2d5a87;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .question-theme {
            font-size: 0.8em;
            padding: 4px 10px;
            border-radius: 4px;
        }
        .theme-meteo { background: #e3f2fd; color: #1565c0; }
        .theme-perf { background: #fff3e0; color: #e65100; }
        .theme-risque { background: #fce4ec; color: #c2185b; }
        .question-text {
            font-size: 1.05em;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .choices { display: flex; flex-direction: column; gap: 10px; }
        .choice {
            display: flex;
            align-items: flex-start;
            padding: 12px 15px;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .choice:hover { border-color: #2d5a87; background: #e8f0f7; }
        .choice.selected { border-color: #2d5a87; background: #d4e5f7; }
        .choice.correct { border-color: #27ae60; background: #d4edda; }
        .choice.incorrect { border-color: #e74c3c; background: #f8d7da; }
        .choice.was-correct { border-color: #27ae60; background: #d4edda; }
        .choice input { margin-right: 12px; margin-top: 3px; }
        .choice label { cursor: pointer; flex: 1; }
        .explanation {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #fff9e6;
            border-left: 4px solid #f39c12;
            border-radius: 4px;
            font-size: 0.95em;
        }
        .explanation.visible { display: block; }
        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn-primary { background: #2d5a87; color: white; }
        .btn-primary:hover { background: #1e3a5f; }
        .btn-secondary { background: #6c757d; color: white; }
        .results {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }
        .results.visible { display: block; }
        .score { font-size: 4em; font-weight: bold; margin: 20px 0; }
        .score.pass { color: #27ae60; }
        .score.fail { color: #e74c3c; }
        .result-details {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .result-item { text-align: center; }
        .result-item .number { font-size: 2em; font-weight: bold; }
        .theme-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .theme-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: left;
        }
        .theme-stat h4 { margin: 0 0 10px 0; }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #eee;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill { height: 100%; border-radius: 5px; }
        .bank-info {
            background: #e8f5e9;
            border: 1px solid #a5d6a7;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        footer {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <header>
        <h1>Examen Blanc BAPD A2</h1>
        <p>Banque de 90 questions - Syllabus EASA AMC1 UAS.OPEN.030(2)(c)</p>
        <p>30 questions tirees aleatoirement (10 par theme) - 60 min - 75% requis</p>
    </header>

    <div class="timer" id="timer">60:00</div>

    <div class="bank-info" id="bankInfo">
        Banque: 90 questions | Session: 30 questions (10 Meteo + 10 Performances + 10 Risques)
    </div>

    <div class="info-box">
        <strong>Programme EASA officiel :</strong><br>
        1. Meteorologie (vent, temperature, visibilite, densite air, previsions)<br>
        2. Performances UAS (enveloppe vol, masse/centrage, batteries, charges)<br>
        3. Attenuation risques sol (mode basse vitesse, distances, regle 1:1)
    </div>

    <div class="results" id="results">
        <h2>Resultat de l'examen</h2>
        <div class="score" id="scoreDisplay">0%</div>
        <div id="passStatus"></div>
        <div class="result-details">
            <div class="result-item">
                <div class="number" id="correctCount" style="color:#27ae60">0</div>
                <div class="label">Bonnes reponses</div>
            </div>
            <div class="result-item">
                <div class="number" id="wrongCount" style="color:#e74c3c">0</div>
                <div class="label">Erreurs</div>
            </div>
            <div class="result-item">
                <div class="number" id="timeUsed">--:--</div>
                <div class="label">Temps utilise</div>
            </div>
        </div>
        <div class="theme-stats" id="themeStats"></div>
    </div>

    <div id="questionsContainer"></div>

    <div class="buttons">
        <button class="btn-primary" id="submitBtn" onclick="submitExam()">Valider l'examen</button>
        <button class="btn-secondary" onclick="resetExam()">Nouvelle session</button>
    </div>

    <footer>
        Conforme au syllabus EASA AMC1 UAS.OPEN.030(2)(c) - Preparation BAPD A2 2026
    </footer>

    <script>
        // =====================================================
        // BANQUE DE 90 QUESTIONS - SYLLABUS EASA BAPD A2
        // =====================================================

        var questionBank = {
            // =========================================
            // THEME 1: METEOROLOGIE (30 questions)
            // =========================================
            meteo: [
                {
                    id: "M01",
                    question: "Quel phenomene meteorologique est le plus dangereux pour un drone multirotor evoluant pres d'un batiment ?",
                    choices: ["La pluie fine", "Les turbulences mecaniques", "Les nuages eleves", "L'humidite relative elevee"],
                    correct: 1,
                    explanation: "Les turbulences mecaniques sont creees par le vent contournant les obstacles. Elles provoquent des variations brutales de vitesse et direction, tres dangereuses pour la stabilite d'un drone en milieu urbain."
                },
                {
                    id: "M02",
                    question: "Un vent de 25 km/h mesure au sol sera generalement a 50m d'altitude :",
                    choices: ["Plus faible (friction diminuee)", "Identique", "Plus fort (gradient de vent)", "Impossible a predire"],
                    correct: 2,
                    explanation: "Le vent augmente avec l'altitude car le frottement au sol diminue (gradient de vent). A 50m, le vent peut etre 20 a 50% plus fort qu'au sol. Crucial pour l'autonomie et la controlabilite."
                },
                {
                    id: "M03",
                    question: "Ou se situent les turbulences les plus dangereuses quand le vent souffle perpendiculairement a un immeuble ?",
                    choices: ["Face au vent, devant l'immeuble", "Sous le vent, derriere l'immeuble", "Au-dessus de l'immeuble uniquement", "Uniformement reparties"],
                    correct: 1,
                    explanation: "Sous le vent (cote abrite), il se forme des tourbillons et zones de recirculation (effet de sillage). La zone dangereuse s'etend jusqu'a 10-15 fois la hauteur de l'obstacle en aval."
                },
                {
                    id: "M04",
                    question: "Les ascendances thermiques sont maximales :",
                    choices: ["Au lever du soleil", "Entre 11h et 16h par temps ensoleille", "En fin de journee", "La nuit par ciel degage"],
                    correct: 1,
                    explanation: "Les thermiques se forment quand le soleil chauffe le sol de maniere differentielle. Maximum en milieu de journee par beau temps. Ces courants verticaux peuvent destabiliser un drone leger."
                },
                {
                    id: "M05",
                    question: "Quelle condition degrade le plus la capacite du telepilote a maintenir le VLOS ?",
                    choices: ["Vent fort", "Temperature elevee", "Brume ou brouillard", "Pression atmospherique basse"],
                    correct: 2,
                    explanation: "La brume et le brouillard reduisent la visibilite. En categorie Ouverte, le vol VLOS est obligatoire. Visibilite reduite = impossible de voir le drone et les obstacles."
                },
                {
                    id: "M06",
                    question: "Le point de rosee correspond a :",
                    choices: ["La temperature maximale de vol", "La temperature ou l'air devient sature (100% HR) et condensation apparait", "Le seuil de vent maximal", "La pression minimale de vol"],
                    correct: 1,
                    explanation: "Au point de rosee, l'air sature condense l'eau. Cela peut former brume, brouillard, ou depot sur le drone (capteurs, optiques, moteurs), compromettant la securite."
                },
                {
                    id: "M07",
                    question: "Une rafale se caracterise par :",
                    choices: ["Un vent constant", "Une augmentation brutale et temporaire de la vitesse du vent", "Un changement lent de direction", "Une baisse de pression"],
                    correct: 1,
                    explanation: "Une rafale est une augmentation soudaine et breve (quelques secondes) pouvant depasser 50% de la vitesse moyenne. Amplifiees par effet Venturi en milieu urbain."
                },
                {
                    id: "M08",
                    question: "L'effet Venturi en milieu urbain provoque :",
                    choices: ["Une reduction du vent entre les batiments", "Une acceleration du vent dans les passages etroits", "Une stabilisation des conditions", "Une augmentation de l'humidite"],
                    correct: 1,
                    explanation: "L'effet Venturi accelere le flux d'air dans les passages etroits (entre batiments, sous porches). Le vent peut y etre 2 a 3 fois plus fort que dans les zones ouvertes."
                },
                {
                    id: "M09",
                    question: "Avant un vol A2, quelle source meteo est la plus fiable ?",
                    choices: ["Meteo de la veille", "Previsions Meteo France ou METAR/TAF local", "Observation visuelle seule", "Application smartphone grand public"],
                    correct: 1,
                    explanation: "Les previsions officielles (Meteo France, METAR/TAF) donnent des informations completes et fiables : vent moyen/rafales, visibilite, precipitations, evolution."
                },
                {
                    id: "M10",
                    question: "Comment la densite de l'air affecte-t-elle un drone multirotor ?",
                    choices: ["Aucun effet", "Air moins dense = moins de portance = moteurs plus sollicites", "Air moins dense = meilleure autonomie", "Air moins dense = meilleure stabilite"],
                    correct: 1,
                    explanation: "Air moins dense (altitude, chaleur) = helices generent moins de portance. Les moteurs tournent plus vite, consommation augmente, autonomie diminue."
                },
                {
                    id: "M11",
                    question: "A quelle temperature les batteries LiPo commencent-elles a perdre significativement en capacite ?",
                    choices: ["En dessous de 25°C", "En dessous de 15°C", "En dessous de 10°C", "En dessous de 0°C uniquement"],
                    correct: 2,
                    explanation: "En dessous de 10°C, les LiPo perdent 20-30% de capacite et leur resistance interne augmente. En dessous de 0°C, risque de coupure brutale. Prechauffage recommande."
                },
                {
                    id: "M12",
                    question: "Le cisaillement de vent (wind shear) est particulierement dangereux car :",
                    choices: ["Il augmente l'autonomie", "Il provoque des variations brutales de vitesse/direction sur courte distance", "Il ameliore la stabilite", "Il reduit les turbulences"],
                    correct: 1,
                    explanation: "Le cisaillement provoque des changements brusques de vent sur de courtes distances verticales ou horizontales. Peut destabiliser brutalement le drone."
                },
                {
                    id: "M13",
                    question: "En conditions de forte chaleur (>35°C), les performances du drone :",
                    choices: ["S'ameliorent (air plus fluide)", "Se degradent (air moins dense, batteries moins efficaces)", "Restent identiques", "Dependent uniquement du vent"],
                    correct: 1,
                    explanation: "Forte chaleur = air moins dense (moins de portance) + batteries LiPo moins performantes et risque de surchauffe. Double penalite sur l'autonomie."
                },
                {
                    id: "M14",
                    question: "Les nuages de type cumulonimbus (Cb) indiquent :",
                    choices: ["Conditions calmes", "Risque d'orages, turbulences severes, rafales descendantes", "Bonne visibilite garantie", "Vent faible assure"],
                    correct: 1,
                    explanation: "Les Cb sont associes aux orages : turbulences severes, rafales descendantes (microbursts), foudre, grele. Vol interdit a proximite."
                },
                {
                    id: "M15",
                    question: "L'inversion de temperature :",
                    choices: ["Disperse les polluants", "Peut pieger brume et pollution pres du sol, reduisant la visibilite", "Ameliore toujours les conditions de vol", "N'a aucun effet sur les drones"],
                    correct: 1,
                    explanation: "L'inversion thermique (air chaud au-dessus de l'air froid) piege les particules et l'humidite pres du sol, creant brume ou smog. Visibilite reduite."
                },
                {
                    id: "M16",
                    question: "Le vent catabatique est :",
                    choices: ["Un vent ascendant chaud", "Un vent descendant froid le long des pentes", "Un vent constant toute la journee", "Un vent de mer"],
                    correct: 1,
                    explanation: "Le vent catabatique est un ecoulement d'air froid descendant les pentes (montagnes, collines) surtout la nuit. Peut etre violent et soudain."
                },
                {
                    id: "M17",
                    question: "Pour un vol prevu a 15h en ete, le risque de thermiques est :",
                    choices: ["Nul", "Faible", "Eleve", "Maximal uniquement apres 18h"],
                    correct: 2,
                    explanation: "15h en ete = pic d'ensoleillement, sol bien chauffe. Thermiques a leur maximum. Turbulences possibles, surtout au-dessus des surfaces sombres."
                },
                {
                    id: "M18",
                    question: "La visibilite meteorologique minimale recommandee pour un vol A2 est :",
                    choices: ["500m", "1 km", "5 km idealement, 1 km minimum selon conditions", "Aucune limite reglementaire"],
                    correct: 2,
                    explanation: "Bien qu'il n'y ait pas de minimum reglementaire strict en Open, une visibilite de 5 km est recommandee. En dessous de 1 km, le VLOS devient difficile."
                },
                {
                    id: "M19",
                    question: "Le brouillard de rayonnement se forme principalement :",
                    choices: ["En milieu de journee", "La nuit et tot le matin par ciel clair et vent faible", "Pendant les orages", "Uniquement en montagne"],
                    correct: 1,
                    explanation: "Le brouillard de rayonnement se forme quand le sol se refroidit la nuit (ciel clair, vent faible). L'air pres du sol atteint le point de rosee. Se dissipe apres le lever du soleil."
                },
                {
                    id: "M20",
                    question: "Un front froid qui approche est generalement associe a :",
                    choices: ["Amelioration immediate des conditions", "Rafales, averses, changement brusque de direction du vent", "Vent stable et visibilite excellente", "Rechauffement progressif"],
                    correct: 1,
                    explanation: "Un front froid apporte : rotation du vent, rafales, averses, baisse de temperature. Passage souvent marque par une ligne de grains."
                },
                {
                    id: "M21",
                    question: "L'echelle Beaufort mesure :",
                    choices: ["La temperature", "La force du vent", "L'humidite", "La pression"],
                    correct: 1,
                    explanation: "L'echelle Beaufort (0-12) mesure la force du vent. Force 4 (20-28 km/h) = brise moderee. Force 6 (39-49 km/h) = vent frais, vol drone deconseille."
                },
                {
                    id: "M22",
                    question: "Un METAR indique '15008G18KT'. Cela signifie :",
                    choices: ["Vent de 150° a 8 km/h", "Vent de 150° a 8 noeuds avec rafales a 18 noeuds", "Temperature 15°C, pression 1008 hPa", "Visibilite 15 km"],
                    correct: 1,
                    explanation: "15008G18KT = vent du 150° (direction), 8 noeuds moyen, rafales (G=gust) a 18 noeuds. 18 kt ≈ 33 km/h en rafales."
                },
                {
                    id: "M23",
                    question: "La brise de mer se developpe :",
                    choices: ["La nuit", "En journee, le vent soufflant de la mer vers la terre", "Uniquement en hiver", "Pendant les tempetes"],
                    correct: 1,
                    explanation: "En journee, la terre chauffe plus vite que la mer. L'air chaud terrestre monte, l'air marin plus frais le remplace. Brise de mer typique l'apres-midi en ete."
                },
                {
                    id: "M24",
                    question: "Les rotors sous le vent d'une colline :",
                    choices: ["Sont des zones calmes", "Sont des zones de turbulences rotatives dangereuses", "Ameliorent la portance", "N'existent qu'au-dessus de 500m"],
                    correct: 1,
                    explanation: "Les rotors sont des tourbillons violents qui se forment sous le vent des reliefs. Turbulences severes, tres dangereuses pour les drones."
                },
                {
                    id: "M25",
                    question: "L'humidite relative de 95% indique :",
                    choices: ["Conditions seches", "Air proche de la saturation, risque de condensation/brouillard", "Conditions ideales de vol", "Vent fort imminent"],
                    correct: 1,
                    explanation: "HR 95% = air presque sature. Legere baisse de temperature suffit pour atteindre le point de rosee et provoquer condensation, brume ou brouillard."
                },
                {
                    id: "M26",
                    question: "En montagne, le vent peut etre significativement different de la prevision en plaine car :",
                    choices: ["Les previsions sont toujours fausses en montagne", "Le relief canalise, accelere ou cree des vents locaux (foehn, catabatique)", "Le vent est toujours plus faible en montagne", "L'altitude n'a aucune influence"],
                    correct: 1,
                    explanation: "Le relief cree des effets locaux : acceleration dans les cols, effet de foehn (vent chaud/sec sous le vent), catabatiques, rotors. Previsions locales indispensables."
                },
                {
                    id: "M27",
                    question: "Le risque de givrage sur un drone existe principalement :",
                    choices: ["Uniquement en hiver au sol", "En vol dans les nuages ou brouillard givrant, temperature proche de 0°C", "Uniquement au-dessus de 3000m", "Jamais sur les petits drones"],
                    correct: 1,
                    explanation: "Givrage possible quand le drone traverse de l'air humide (nuages, brouillard) pres de 0°C. Glace sur helices = desequilibre, perte de portance."
                },
                {
                    id: "M28",
                    question: "Un QNH de 1013 hPa correspond a :",
                    choices: ["Une basse pression (depression)", "La pression standard au niveau de la mer", "Une haute pression (anticyclone)", "Un vent de 13 noeuds"],
                    correct: 1,
                    explanation: "1013.25 hPa = pression atmospherique standard au niveau de la mer. QNH > 1013 = anticyclone (temps stable). QNH < 1013 = depression (temps perturbe)."
                },
                {
                    id: "M29",
                    question: "La meilleure periode pour eviter les turbulences thermiques en ete est :",
                    choices: ["Entre 12h et 15h", "Le matin tot ou en fin de journee", "A midi pile", "Aucune difference dans la journee"],
                    correct: 1,
                    explanation: "Tot le matin (avant 9h) ou en soiree (apres 18h), le sol est moins chauffe. Thermiques faibles ou absents. Conditions plus stables pour le vol."
                },
                {
                    id: "M30",
                    question: "Un TAF est une prevision meteorologique valable pour :",
                    choices: ["1 heure", "6 heures", "9 a 30 heures selon le type", "1 semaine"],
                    correct: 2,
                    explanation: "Le TAF (Terminal Aerodrome Forecast) est une prevision pour les aerodromes, valable 9h (TAF court) a 30h (TAF long). Utile pour planifier les vols drone a proximite."
                }
            ],

            // =========================================
            // THEME 2: PERFORMANCES UAS (30 questions)
            // =========================================
            perf: [
                {
                    id: "P01",
                    question: "Quelle est la MTOM maximale d'un drone classe C2 ?",
                    choices: ["250g", "900g", "4 kg", "25 kg"],
                    correct: 2,
                    explanation: "Les drones C2 ont une MTOM < 4 kg. Autorises en A2 pour voler a proximite des personnes (30m, ou 5m en mode basse vitesse)."
                },
                {
                    id: "P02",
                    question: "Le mode 'basse vitesse' d'un drone C2 limite la vitesse a :",
                    choices: ["5 m/s", "3 m/s (environ 11 km/h)", "10 m/s", "15 km/h"],
                    correct: 1,
                    explanation: "Mode basse vitesse C2 = max 3 m/s (≈11 km/h). Obligatoire pour reduire la distance aux personnes de 30m a 5m."
                },
                {
                    id: "P03",
                    question: "Une batterie LiPo 2200mAh 10C peut delivrer un courant maximal de :",
                    choices: ["2.2A", "10A", "22A", "220A"],
                    correct: 2,
                    explanation: "Courant max = Capacite × C-rate. 2.2Ah × 10C = 22A. C'est le courant de decharge maximal continu."
                },
                {
                    id: "P04",
                    question: "Une batterie 6S LiPo a une tension nominale de :",
                    choices: ["3.7V", "11.1V", "22.2V", "25.2V"],
                    correct: 2,
                    explanation: "6S = 6 cellules en serie. Tension nominale par cellule = 3.7V. Total = 6 × 3.7V = 22.2V nominal."
                },
                {
                    id: "P05",
                    question: "Batterie 2200mAh en configuration 2P. Quelle est la capacite totale ?",
                    choices: ["2200mAh", "4400mAh", "1100mAh", "2200mAh mais tension doublee"],
                    correct: 1,
                    explanation: "En parallele (P), les capacites s'additionnent. 2P × 2200mAh = 4400mAh. La tension reste identique."
                },
                {
                    id: "P06",
                    question: "Batterie 3S2P avec cellules 2200mAh. Tension et capacite totales ?",
                    choices: ["11.1V / 2200mAh", "11.1V / 4400mAh", "22.2V / 4400mAh", "7.4V / 4400mAh"],
                    correct: 1,
                    explanation: "3S = 3 × 3.7V = 11.1V. 2P = 2 × 2200mAh = 4400mAh. Configuration finale : 11.1V nominal, 4400mAh capacite."
                },
                {
                    id: "P07",
                    question: "Batterie 6S2P, cellules 2200mAh 10C. Puissance maximale (tension nominale) ?",
                    choices: ["244W", "488W", "977W", "1955W"],
                    correct: 2,
                    explanation: "6S = 22.2V nominal. 2P avec 10C : courant max = 2.2A × 10 × 2 = 44A. Puissance = 22.2V × 44A = 976.8W ≈ 977W."
                },
                {
                    id: "P08",
                    question: "Une cellule LiPo ne doit jamais etre dechargee en dessous de :",
                    choices: ["4.2V", "3.7V", "3.0V", "2.5V"],
                    correct: 2,
                    explanation: "Tension minimale LiPo = 3.0V par cellule. En dessous, dommages irreversibles (capacite reduite, gonflement, risque incendie)."
                },
                {
                    id: "P09",
                    question: "L'autonomie annoncee '25 minutes' par le constructeur correspond a :",
                    choices: ["Vol avec vent modere et charge utile", "Stationnaire, sans vent, batterie neuve, sans charge", "Conditions reelles moyennes", "Temps jusqu'a extinction complete"],
                    correct: 1,
                    explanation: "L'autonomie constructeur = conditions ideales (stationnaire, sans vent, batterie neuve 100%, temperature moderee). Reel = 30-50% de moins."
                },
                {
                    id: "P10",
                    question: "Pour maintenir 10 m/s au sol avec 5 m/s de vent de face, la vitesse-air doit etre :",
                    choices: ["5 m/s", "10 m/s", "15 m/s", "20 m/s"],
                    correct: 2,
                    explanation: "Vitesse-sol = Vitesse-air - Vent de face. Pour 10 m/s sol avec 5 m/s de face : 10 + 5 = 15 m/s vitesse-air. Consommation accrue."
                },
                {
                    id: "P11",
                    question: "La fonction RTH (Return To Home) peut etre declenchee par :",
                    choices: ["Uniquement manuellement", "Perte de liaison, batterie critique, ou action manuelle", "Uniquement en cas de crash", "Le geofencing exclusivement"],
                    correct: 1,
                    explanation: "RTH activable : manuellement (bouton), automatiquement en failsafe (perte liaison), ou a batterie critique. L'altitude RTH doit etre > obstacles."
                },
                {
                    id: "P12",
                    question: "Le geofencing sur un drone C2 :",
                    choices: ["Est optionnel", "Utilise le GPS pour limiter les zones de vol", "Ne fonctionne qu'en interieur", "Desactive le mode basse vitesse"],
                    correct: 1,
                    explanation: "Le geofencing utilise le GPS pour definir des zones interdites (aeroports, zones sensibles) ou de confinement. Obligatoire sur C1, C2, C3."
                },
                {
                    id: "P13",
                    question: "Le Remote ID d'un drone C2 transmet :",
                    choices: ["Uniquement le numero de serie", "Position, altitude, vitesse, identifiant, position telepilote", "Les images de la camera", "Rien en vol stationnaire"],
                    correct: 1,
                    explanation: "Remote ID transmet en continu : ID enregistrement, position/altitude drone, vitesse/direction, position decollage ou telepilote, horodatage."
                },
                {
                    id: "P14",
                    question: "Le geo-awareness alerte le telepilote :",
                    choices: ["Jamais", "Quand il approche d'une zone reglementee", "Uniquement apres avoir franchi une zone interdite", "Seulement si le GPS est defaillant"],
                    correct: 1,
                    explanation: "Le geo-awareness alerte (sans bloquer) quand on approche d'une zone sensible. La base doit etre mise a jour regulierement. Exigence C2."
                },
                {
                    id: "P15",
                    question: "En failsafe (perte de liaison), un drone C2 bien configure doit :",
                    choices: ["Couper les moteurs immediatement", "Accelerer pour retrouver le signal", "Executer une procedure preprogrammee (RTH, atterrissage, hover)", "Continuer indefiniment tout droit"],
                    correct: 2,
                    explanation: "En failsafe, le drone execute une procedure predefinie : RTH, atterrissage sur place, ou hover pendant un delai. A configurer et tester avant vol."
                },
                {
                    id: "P16",
                    question: "Le centrage (CG) d'un drone est critique car :",
                    choices: ["Il n'a aucune importance sur un multirotor", "Un mauvais CG degrade la stabilite et augmente la consommation", "Il affecte uniquement l'esthetique", "Seul le poids total compte"],
                    correct: 1,
                    explanation: "Un CG decentre force le controleur a compenser en permanence. Resultat : instabilite, vibrations, consommation accrue, usure prematuree des moteurs."
                },
                {
                    id: "P17",
                    question: "L'ajout d'une charge utile de 500g sur un drone :",
                    choices: ["N'a aucun effet si la MTOM n'est pas depassee", "Modifie le CG, reduit l'autonomie, peut affecter la stabilite", "Ameliore toujours la stabilite", "Augmente l'autonomie"],
                    correct: 1,
                    explanation: "Toute charge supplementaire : deplace le CG (a verifier), augmente le poids (autonomie reduite), peut modifier le comportement en vol."
                },
                {
                    id: "P18",
                    question: "L'energie stockee dans une batterie 4S 5000mAh est d'environ :",
                    choices: ["20 Wh", "50 Wh", "74 Wh", "100 Wh"],
                    correct: 2,
                    explanation: "Energie (Wh) = Tension × Capacite. 4S = 14.8V nominal. 14.8V × 5Ah = 74 Wh."
                },
                {
                    id: "P19",
                    question: "Une batterie LiPo 'gonflee' :",
                    choices: ["Est normale apres utilisation", "Indique un dommage interne, ne plus utiliser", "A juste besoin d'etre dechargee", "Offre plus de capacite"],
                    correct: 1,
                    explanation: "Gonflement = production de gaz due a une degradation interne. Risque d'incendie/explosion. A mettre hors service immediatement et recycler."
                },
                {
                    id: "P20",
                    question: "Pour un stockage longue duree, une LiPo doit etre chargee a :",
                    choices: ["100% (4.2V/cellule)", "Environ 50-60% (3.8V/cellule)", "Completement dechargee (3.0V/cellule)", "Le niveau n'a pas d'importance"],
                    correct: 1,
                    explanation: "Stockage ideal : 3.7-3.85V par cellule (50-60%). Ni pleine (stress chimique) ni vide (sulfatation). Prolonge la duree de vie."
                },
                {
                    id: "P21",
                    question: "L'altitude densite affecte un drone car :",
                    choices: ["Le GPS est moins precis en altitude", "L'air moins dense reduit la portance et l'efficacite des helices", "Les batteries fonctionnent mieux", "Elle n'a aucun effet sous 1000m"],
                    correct: 1,
                    explanation: "Altitude densite = altitude corrigee pour temperature/pression. Air moins dense = moins de portance, moteurs plus sollicites, autonomie reduite."
                },
                {
                    id: "P22",
                    question: "Un drone C2 doit avoir un systeme de terminaison de vol qui :",
                    choices: ["N'est pas obligatoire", "Permet d'arreter le vol en cas d'urgence de maniere previsible", "Accelere le drone vers le sol", "Desactive le GPS"],
                    correct: 1,
                    explanation: "Le systeme de terminaison de vol (FTS ou equivalent) permet de mettre fin au vol de maniere previsible en urgence (coupure moteurs, parachute, etc.)."
                },
                {
                    id: "P23",
                    question: "Le 'C-rate' de charge typique recommande pour une LiPo est de :",
                    choices: ["0.5C a 1C", "2C a 3C", "5C minimum", "10C pour une charge rapide"],
                    correct: 0,
                    explanation: "Charge recommandee : 0.5C a 1C pour preserver la batterie. Une 2200mAh se charge idealement a 2.2A max (1C). Charge rapide = usure acceleree."
                },
                {
                    id: "P24",
                    question: "En cas de temperature ambiante de -5°C, avant le vol il faut :",
                    choices: ["Voler immediatement pour rechauffer la batterie", "Prechauffer les batteries au-dessus de 15°C", "Utiliser des batteries plus petites", "Augmenter le C-rate"],
                    correct: 1,
                    explanation: "Batteries froides = capacite reduite, resistance interne elevee, risque de coupure. Prechauffer au-dessus de 15-20°C avant vol."
                },
                {
                    id: "P25",
                    question: "La plage de CG acceptable pour un drone est definie par :",
                    choices: ["Le telepilote selon son experience", "Le constructeur dans le manuel", "La reglementation EASA", "Elle n'existe pas pour les multirotors"],
                    correct: 1,
                    explanation: "Le constructeur specifie la plage de CG acceptable dans le manuel. A respecter imperativement pour garantir la stabilite et la securite."
                },
                {
                    id: "P26",
                    question: "Batterie 4S 3000mAh 25C. Courant de decharge max et puissance max ?",
                    choices: ["25A / 370W", "75A / 1110W", "30A / 444W", "75A / 925W"],
                    correct: 1,
                    explanation: "Courant max = 3Ah × 25C = 75A. Puissance = 14.8V × 75A = 1110W. C'est la puissance instantanee maximale."
                },
                {
                    id: "P27",
                    question: "Le BEC (Battery Eliminator Circuit) sur un drone sert a :",
                    choices: ["Eliminer la batterie", "Fournir une tension regulee pour l'electronique de bord", "Augmenter la puissance des moteurs", "Gerer le GPS"],
                    correct: 1,
                    explanation: "Le BEC convertit la tension batterie principale en tension stable (5V, 12V) pour alimenter recepteur, controleur de vol, servos, etc."
                },
                {
                    id: "P28",
                    question: "L'enveloppe de vol d'un drone definit :",
                    choices: ["Le volume de la housse de transport", "Les limites operationnelles (vitesse, altitude, vent max, temperature)", "Uniquement la zone geographique autorisee", "Le nombre de batteries emportees"],
                    correct: 1,
                    explanation: "L'enveloppe de vol = ensemble des conditions dans lesquelles le drone peut operer en securite : vitesses min/max, vent max, plage de temperature, altitude max."
                },
                {
                    id: "P29",
                    question: "Un vol avec une charge utile mal arrimee peut provoquer :",
                    choices: ["Rien si elle est legere", "Deplacement du CG en vol, vibrations, perte de controle", "Amelioration de la stabilite", "Augmentation de l'autonomie"],
                    correct: 1,
                    explanation: "Charge mal fixee = risque de deplacement en vol, modifiant le CG dynamiquement. Peut causer vibrations, instabilite, voire crash."
                },
                {
                    id: "P30",
                    question: "Un drone perd la liaison C2 (command & control). Selon la programmation, il :",
                    choices: ["Tombe immediatement", "Execute la procedure failsafe (RTH, atterrissage, hover)", "Accelere pour retrouver le signal", "Continue sa mission indefiniment"],
                    correct: 1,
                    explanation: "En cas de perte de liaison C2, le failsafe s'active selon la configuration : RTH, atterrissage immediat, hover sur place pendant X secondes puis RTH, etc."
                }
            ],

            // =========================================
            // THEME 3: ATTENUATION RISQUES SOL (30 questions)
            // =========================================
            risque: [
                {
                    id: "R01",
                    question: "En A2 avec drone C2, quelle est la distance horizontale minimale des personnes non impliquees ?",
                    choices: ["5m toujours", "30m (ou 5m en mode basse vitesse)", "50m sans exception", "150m"],
                    correct: 1,
                    explanation: "A2 + C2 : 30m minimum. Reductible a 5m SI mode basse vitesse (≤3 m/s) actif ET evaluation de la situation favorable."
                },
                {
                    id: "R02",
                    question: "Une 'personne non impliquee' est :",
                    choices: ["Toute personne sans gilet jaune", "Toute personne ne participant pas a l'operation et non informee des consignes", "Uniquement les mineurs", "Toute personne a plus de 100m"],
                    correct: 1,
                    explanation: "Personne non impliquee = ne participe pas a l'operation UAS et n'a pas ete informee des consignes de securite par l'exploitant."
                },
                {
                    id: "R03",
                    question: "La regle du 1:1 en A2 signifie :",
                    choices: ["1 drone pour 1 telepilote", "Distance horizontale ≥ hauteur de vol", "1 vol par jour", "1 batterie pour 1 heure de vol"],
                    correct: 1,
                    explanation: "Regle 1:1 : la distance horizontale minimale des personnes doit etre au moins egale a la hauteur de vol. Vol a 30m = distance min 30m."
                },
                {
                    id: "R04",
                    question: "Le survol de rassemblements de personnes en categorie Ouverte est :",
                    choices: ["Autorise en A2 avec C2", "Autorise si drone < 250g", "Toujours interdit quelle que soit la classe", "Autorise avec autorisation prefectorale"],
                    correct: 2,
                    explanation: "En categorie Ouverte (A1, A2, A3), le survol de rassemblements est TOUJOURS INTERDIT. Necessite la categorie Specifique avec autorisation."
                },
                {
                    id: "R05",
                    question: "Avant chaque vol A2, le telepilote doit :",
                    choices: ["Deposer un plan de vol en prefecture", "Evaluer l'environnement et identifier les risques", "Obtenir l'accord ecrit des riverains", "Faire inspecter le drone par la DGAC"],
                    correct: 1,
                    explanation: "Avant chaque vol : evaluer meteo, espace aerien, presence de personnes/obstacles, etat du drone/batteries, definir procedures d'urgence."
                },
                {
                    id: "R06",
                    question: "En cas de survol involontaire de personnes avec un C2, la premiere action est de :",
                    choices: ["Continuer le vol", "Couper les moteurs immediatement", "S'eloigner de maniere securisee des personnes", "Prendre des photos pour preuve"],
                    correct: 2,
                    explanation: "Survol non autorise en Open/C2. S'eloigner des personnes de maniere securisee, sans mouvements brusques qui augmenteraient le risque."
                },
                {
                    id: "R07",
                    question: "Les protege-helices reduisent les risques car :",
                    choices: ["Ils augmentent la vitesse", "Ils empechent le contact direct des pales avec les personnes", "Ils ameliorent l'autonomie", "Ils sont juste esthetiques"],
                    correct: 1,
                    explanation: "Les protege-helices evitent les lacerations en cas de contact. Combines a une vitesse reduite, ils diminuent significativement la gravite des blessures."
                },
                {
                    id: "R08",
                    question: "Des enfants s'approchent de votre zone de vol A2. Vous devez :",
                    choices: ["Continuer en les surveillant", "Monter en altitude pour passer au-dessus", "Interrompre ou vous eloigner pour maintenir les distances", "Leur demander de partir et continuer"],
                    correct: 2,
                    explanation: "Le telepilote est responsable du maintien des distances. Adapter le vol (eloignement) ou interrompre. On ne peut pas compter sur le comportement des tiers."
                },
                {
                    id: "R09",
                    question: "Le vol de nuit en categorie Ouverte A2 est :",
                    choices: ["Toujours interdit", "Autorise si drone equipe de feux et VLOS maintenu", "Autorise sans condition", "Interdit sauf au-dessus de la mer"],
                    correct: 1,
                    explanation: "Vol de nuit possible en Open si : drone equipe de feux (position et direction), telepilote maintient VLOS, conditions permettent un vol sur. Restrictions nationales possibles."
                },
                {
                    id: "R10",
                    question: "Une 'zone tampon' en exploitation drone est :",
                    choices: ["La zone de stockage batteries", "Une marge de securite supplementaire autour de la zone de vol", "Le rayon d'action de la telecommande", "L'espace au-dessus de 120m"],
                    correct: 1,
                    explanation: "Zone tampon = marge prenant en compte imprecisions GPS, rafales, temps de reaction, erreurs de pilotage. Augmente la securite reelle."
                },
                {
                    id: "R11",
                    question: "La hauteur maximale en categorie Ouverte A2 est de :",
                    choices: ["50m AGL", "120m AGL", "150m AGL", "Illimitee"],
                    correct: 1,
                    explanation: "En categorie Ouverte (A1/A2/A3), hauteur max = 120m AGL (Above Ground Level). Restrictions locales possibles (aerodromes, etc.)."
                },
                {
                    id: "R12",
                    question: "L'evaluation pre-vol de l'environnement operationnel inclut :",
                    choices: ["Uniquement la meteo", "Meteo, espace aerien, personnes, obstacles, infrastructures critiques", "Seulement l'etat du drone", "Uniquement la zone de decollage"],
                    correct: 1,
                    explanation: "Evaluation pre-vol complete : conditions meteo, espace aerien (zones, restrictions), presence de personnes, obstacles, infrastructures sensibles, etat du drone."
                },
                {
                    id: "R13",
                    question: "En A2, peut-on survoler des routes ouvertes a la circulation ?",
                    choices: ["Oui sans restriction", "Oui si distance aux vehicules respectee, brievement, sans stationnement au-dessus", "Non, jamais", "Uniquement la nuit"],
                    correct: 1,
                    explanation: "Survol de routes possible en A2 si : distances respectees, traversee breve, pas de vol stationnaire au-dessus, evaluation du risque favorable."
                },
                {
                    id: "R14",
                    question: "L'energie cinetique d'un drone en cas de chute depend de :",
                    choices: ["Uniquement la hauteur", "La masse et le carre de la vitesse (Ec = 1/2 mv²)", "La couleur du drone", "Uniquement de la vitesse"],
                    correct: 1,
                    explanation: "Energie cinetique = 1/2 × masse × vitesse². Doubler la vitesse = quadrupler l'energie d'impact. D'ou l'importance du mode basse vitesse."
                },
                {
                    id: "R15",
                    question: "Une personne est consideree comme 'impliquee' dans l'operation si :",
                    choices: ["Elle regarde le drone", "Elle participe a l'operation et a ete informee des consignes et risques", "Elle porte un gilet jaune", "Elle est a moins de 30m"],
                    correct: 1,
                    explanation: "Personne impliquee : participe a l'operation, a recu les instructions de securite, comprend les risques, peut surveiller la position du drone."
                },
                {
                    id: "R16",
                    question: "Le telepilote constate un dysfonctionnement en vol (vibrations anormales). Il doit :",
                    choices: ["Continuer pour terminer la mission", "Atterrir des que possible de maniere securisee", "Ignorer si le drone vole encore", "Augmenter l'altitude"],
                    correct: 1,
                    explanation: "Tout comportement anormal = atterrissage immediat et securise. Les vibrations peuvent indiquer une helice endommagee, risque de defaillance imminente."
                },
                {
                    id: "R17",
                    question: "L'utilisation du mode basse vitesse est obligatoire pour :",
                    choices: ["Tous les vols A2", "Reduire la distance aux personnes de 30m a 5m", "Le decollage uniquement", "Les vols de nuit"],
                    correct: 1,
                    explanation: "Mode basse vitesse (≤3 m/s) obligatoire pour passer de 30m a 5m des personnes non impliquees. Reduit l'energie cinetique en cas de collision."
                },
                {
                    id: "R18",
                    question: "Un drone C2 doit afficher :",
                    choices: ["Uniquement le nom du fabricant", "Le marquage CE et l'etiquette de classe C2", "La puissance en watts", "Le nom du proprietaire"],
                    correct: 1,
                    explanation: "Drone C2 doit porter le marquage CE et l'etiquette de classe (C2). Garantit la conformite aux exigences techniques europeennes."
                },
                {
                    id: "R19",
                    question: "En cas d'urgence aerienne (helicoptere SAMU), le telepilote doit :",
                    choices: ["Continuer son vol en surveillant", "Atterrir immediatement et ne pas interferer", "Monter pour laisser passer l'helicoptere", "Signaler sa position par radio"],
                    correct: 1,
                    explanation: "Priorite absolue aux services d'urgence. Atterrir immediatement, ne pas interferer avec les operations de secours. Reprendre uniquement apres leur depart."
                },
                {
                    id: "R20",
                    question: "Un vol en A2 dans un parc public est :",
                    choices: ["Toujours interdit", "Possible si distances aux non-impliques respectees et pas de rassemblement", "Autorise sans restriction", "Reserve aux professionnels"],
                    correct: 1,
                    explanation: "Vol en parc possible si : distances respectees (30m ou 5m avec basse vitesse), pas de survol de rassemblement, conditions meteo OK, reglementation locale respectee."
                },
                {
                    id: "R21",
                    question: "Le telepilote doit pouvoir intervenir sur le drone :",
                    choices: ["Uniquement au decollage", "A tout moment du vol", "Seulement en cas de crash", "Uniquement a l'atterrissage"],
                    correct: 1,
                    explanation: "Le telepilote doit garder le controle et pouvoir intervenir a tout moment. Pas de vol autonome en categorie Ouverte."
                },
                {
                    id: "R22",
                    question: "La preparation d'un vol A2 inclut la verification :",
                    choices: ["Uniquement du niveau de batterie", "De l'etat complet du drone, batteries, mise a jour geo-awareness, conditions", "Seulement de la meteo", "Du numero de telephone des secours"],
                    correct: 1,
                    explanation: "Verification complete : etat mecanique, batteries (charge, etat), firmware a jour, geo-awareness a jour, meteo, espace aerien, obstacles, personnes."
                },
                {
                    id: "R23",
                    question: "Un observateur UA peut etre utilise pour :",
                    choices: ["Piloter le drone a la place du telepilote", "Aider le telepilote a maintenir le VLOS et surveiller l'environnement", "Filmer la mission", "Rien, c'est interdit en A2"],
                    correct: 1,
                    explanation: "L'observateur UA aide le telepilote : maintien du VLOS, surveillance de l'environnement (personnes, obstacles, trafic aerien). Communication directe obligatoire."
                },
                {
                    id: "R24",
                    question: "En A2, le survol d'infrastructures critiques (centrales, prisons) est :",
                    choices: ["Autorise avec un drone C2", "Interdit ou soumis a autorisation speciale", "Autorise si altitude < 50m", "Autorise de nuit uniquement"],
                    correct: 1,
                    explanation: "Le survol d'infrastructures sensibles est interdit ou soumis a autorisation specifique selon la reglementation nationale. En France, verifier sur Geoportail."
                },
                {
                    id: "R25",
                    question: "Le declenchement du RTH automatique a 30% de batterie :",
                    choices: ["Est excessif, 10% suffit", "Est une mesure de securite recommendee", "Est interdit par la reglementation", "Reduit les performances"],
                    correct: 1,
                    explanation: "RTH a 30% = marge de securite pour le retour. Prend en compte : distance, vent de face, altitude RTH, marge pour imprevus. 10% = trop juste."
                },
                {
                    id: "R26",
                    question: "Voler a 5m d'une personne non impliquee sans mode basse vitesse actif :",
                    choices: ["Est autorise avec un C2", "Constitue une infraction a la reglementation A2", "Est possible si le telepilote est experimente", "Ne pose aucun probleme"],
                    correct: 1,
                    explanation: "5m des personnes = mode basse vitesse OBLIGATOIRE. Sans ce mode, distance minimale = 30m. Infraction = sanctions possibles."
                },
                {
                    id: "R27",
                    question: "L'enregistrement de l'exploitant UAS est obligatoire pour :",
                    choices: ["Aucun drone en A2", "Tout drone de 250g+ ou equipe d'une camera", "Uniquement les drones professionnels", "Les drones de plus de 4 kg"],
                    correct: 1,
                    explanation: "Enregistrement obligatoire si : MTOM ≥ 250g OU capteur capable de collecter des donnees personnelles (camera). Numero operateur sur le drone."
                },
                {
                    id: "R28",
                    question: "Un accident de drone causant des blessures doit etre :",
                    choices: ["Garde secret", "Declare a l'autorite competente selon le reglement 376/2014", "Signale uniquement si demande par la victime", "Declare seulement si mortel"],
                    correct: 1,
                    explanation: "Les accidents et incidents graves doivent etre declares a l'autorite competente (BEA en France). Obligation legale pour ameliorer la securite."
                },
                {
                    id: "R29",
                    question: "Pour voler en A2 a proximite d'un aerodrome, il faut :",
                    choices: ["Rien de special, la categorie Ouverte suffit", "Verifier les zones et restrictions, obtenir les autorisations necessaires", "Juste rester sous 50m", "Attendre qu'il n'y ait pas de trafic"],
                    correct: 1,
                    explanation: "Proximite aerodrome : verifier les zones (CTR, ATZ, etc.) sur Geoportail/AlphaTango. Autorisation souvent necessaire. Certaines zones interdites."
                },
                {
                    id: "R30",
                    question: "La responsabilite en cas de dommage cause par un drone incombe a :",
                    choices: ["Uniquement au fabricant", "L'exploitant UAS et/ou le telepilote", "Personne, c'est un accident", "L'Etat"],
                    correct: 1,
                    explanation: "L'exploitant UAS et le telepilote sont responsables des dommages causes. Assurance RC obligatoire. Le fabricant peut etre engage en cas de defaut produit."
                }
            ]
        };

        // Variables globales
        var currentQuestions = [];
        var timerInterval = null;
        var startTime = null;
        var timeRemaining = 3600;
        var examSubmitted = false;
        var userAnswers = {};

        function shuffleArray(array) {
            var shuffled = array.slice();
            for (var i = shuffled.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = shuffled[i];
                shuffled[i] = shuffled[j];
                shuffled[j] = temp;
            }
            return shuffled;
        }

        function selectQuestions() {
            // Selectionner 10 questions aleatoires par theme
            var meteoQuestions = shuffleArray(questionBank.meteo).slice(0, 10);
            var perfQuestions = shuffleArray(questionBank.perf).slice(0, 10);
            var risqueQuestions = shuffleArray(questionBank.risque).slice(0, 10);

            // Ajouter le theme a chaque question
            for (var i = 0; i < meteoQuestions.length; i++) {
                meteoQuestions[i].theme = "Meteo";
                meteoQuestions[i].themeClass = "theme-meteo";
            }
            for (var i = 0; i < perfQuestions.length; i++) {
                perfQuestions[i].theme = "Performances";
                perfQuestions[i].themeClass = "theme-perf";
            }
            for (var i = 0; i < risqueQuestions.length; i++) {
                risqueQuestions[i].theme = "Risques";
                risqueQuestions[i].themeClass = "theme-risque";
            }

            // Combiner et melanger l'ordre final
            currentQuestions = shuffleArray(meteoQuestions.concat(perfQuestions, risqueQuestions));
        }

        function initExam() {
            var container = document.getElementById('questionsContainer');
            if (!container) return;
            container.innerHTML = '';

            selectQuestions();

            for (var idx = 0; idx < currentQuestions.length; idx++) {
                var q = currentQuestions[idx];
                var questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.id = 'question-' + q.id;

                // Melanger les choix
                var choicesWithIndex = [];
                for (var ci = 0; ci < q.choices.length; ci++) {
                    choicesWithIndex.push({ text: q.choices[ci], originalIndex: ci });
                }
                var shuffledChoices = shuffleArray(choicesWithIndex);

                var newCorrectIndex = -1;
                for (var sci = 0; sci < shuffledChoices.length; sci++) {
                    if (shuffledChoices[sci].originalIndex === q.correct) {
                        newCorrectIndex = sci;
                        break;
                    }
                }
                q.shuffledCorrect = newCorrectIndex;
                q.shuffledChoices = shuffledChoices;

                var choicesHtml = '';
                for (var chi = 0; chi < shuffledChoices.length; chi++) {
                    choicesHtml += '<div class="choice" onclick="selectAnswer(\'' + q.id + '\', ' + chi + ')">' +
                        '<input type="radio" name="q' + q.id + '" id="q' + q.id + '_' + chi + '" value="' + chi + '">' +
                        '<label for="q' + q.id + '_' + chi + '">' + shuffledChoices[chi].text + '</label>' +
                        '</div>';
                }

                questionDiv.innerHTML =
                    '<div class="question-header">' +
                        '<span class="question-number">Question ' + (idx + 1) + '/30</span>' +
                        '<span class="question-theme ' + q.themeClass + '">' + q.theme + '</span>' +
                    '</div>' +
                    '<div class="question-text">' + q.question + '</div>' +
                    '<div class="choices">' + choicesHtml + '</div>' +
                    '<div class="explanation" id="explanation-' + q.id + '">' +
                        '<strong>Explication :</strong> ' + q.explanation +
                    '</div>';

                container.appendChild(questionDiv);
            }

            startTimer();
            startTime = Date.now();
        }

        function selectAnswer(questionId, choiceIndex) {
            if (examSubmitted) return;

            var questionDiv = document.getElementById('question-' + questionId);
            var choices = questionDiv.querySelectorAll('.choice');

            for (var i = 0; i < choices.length; i++) {
                choices[i].classList.remove('selected');
                if (i === choiceIndex) {
                    choices[i].classList.add('selected');
                    choices[i].querySelector('input').checked = true;
                }
            }

            userAnswers[questionId] = choiceIndex;
        }

        function startTimer() {
            timerInterval = setInterval(function() {
                timeRemaining--;
                var minutes = Math.floor(timeRemaining / 60);
                var seconds = timeRemaining % 60;
                var timerEl = document.getElementById('timer');
                timerEl.textContent = (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;

                if (timeRemaining <= 300) {
                    timerEl.classList.add('warning');
                }

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    submitExam();
                }
            }, 1000);
        }

        function submitExam() {
            if (examSubmitted) return;

            var unansweredCount = 0;
            for (var i = 0; i < currentQuestions.length; i++) {
                if (userAnswers[currentQuestions[i].id] === undefined) {
                    unansweredCount++;
                }
            }

            if (unansweredCount > 0 && timeRemaining > 0) {
                if (!confirm('Attention : ' + unansweredCount + ' question(s) sans reponse.\n\nVoulez-vous vraiment valider ?')) {
                    return;
                }
            }

            examSubmitted = true;
            clearInterval(timerInterval);

            var endTime = Date.now();
            var timeUsed = Math.floor((endTime - startTime) / 1000);
            var minutesUsed = Math.floor(timeUsed / 60);
            var secondsUsed = timeUsed % 60;

            var correct = 0;
            var themeScores = {
                'Meteo': { correct: 0, total: 0 },
                'Performances': { correct: 0, total: 0 },
                'Risques': { correct: 0, total: 0 }
            };

            for (var qi = 0; qi < currentQuestions.length; qi++) {
                var q = currentQuestions[qi];
                var questionDiv = document.getElementById('question-' + q.id);
                var choices = questionDiv.querySelectorAll('.choice');
                var userAnswer = userAnswers[q.id];
                var correctAnswer = q.shuffledCorrect;

                themeScores[q.theme].total++;

                for (var ci = 0; ci < choices.length; ci++) {
                    choices[ci].style.cursor = 'default';
                    if (ci === correctAnswer) {
                        choices[ci].classList.add('was-correct');
                    }
                    if (userAnswer === ci && ci !== correctAnswer) {
                        choices[ci].classList.add('incorrect');
                    }
                    if (userAnswer === ci && ci === correctAnswer) {
                        choices[ci].classList.remove('was-correct');
                        choices[ci].classList.add('correct');
                    }
                }

                if (userAnswer === correctAnswer) {
                    correct++;
                    themeScores[q.theme].correct++;
                }

                document.getElementById('explanation-' + q.id).classList.add('visible');
            }

            var percentage = Math.round((correct / 30) * 100);
            var passed = percentage >= 75;

            document.getElementById('scoreDisplay').textContent = percentage + '%';
            document.getElementById('scoreDisplay').className = 'score ' + (passed ? 'pass' : 'fail');
            document.getElementById('passStatus').innerHTML = passed
                ? '<span style="color:#27ae60;font-size:1.5em">ADMIS (75%+)</span>'
                : '<span style="color:#e74c3c;font-size:1.5em">AJOURNE (' + (75 - percentage) + '% manquants)</span>';
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('wrongCount').textContent = 30 - correct;
            document.getElementById('timeUsed').textContent = minutesUsed + ':' + (secondsUsed < 10 ? '0' : '') + secondsUsed;

            var themeStatsDiv = document.getElementById('themeStats');
            themeStatsDiv.innerHTML = '';
            var themeNames = ['Meteo', 'Performances', 'Risques'];
            var themeLabels = {'Meteo': 'Meteorologie', 'Performances': 'Performances UAS', 'Risques': 'Attenuation risques'};
            for (var ti = 0; ti < themeNames.length; ti++) {
                var theme = themeNames[ti];
                var scores = themeScores[theme];
                var pct = Math.round((scores.correct / scores.total) * 100);
                var statDiv = document.createElement('div');
                statDiv.className = 'theme-stat';
                statDiv.innerHTML = '<h4>' + themeLabels[theme] + '</h4>' +
                    '<div>' + scores.correct + '/' + scores.total + ' (' + pct + '%)</div>' +
                    '<div class="progress-bar">' +
                    '<div class="progress-fill" style="width:' + pct + '%;background:' + (pct >= 75 ? '#27ae60' : '#e74c3c') + '"></div>' +
                    '</div>';
                themeStatsDiv.appendChild(statDiv);
            }

            document.getElementById('results').classList.add('visible');
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('timer').style.display = 'none';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetExam() {
            if (!confirm('Nouvelle session avec 30 nouvelles questions aleatoires ?')) return;

            examSubmitted = false;
            userAnswers = {};
            timeRemaining = 3600;

            document.getElementById('results').classList.remove('visible');
            document.getElementById('submitBtn').style.display = 'inline-block';
            document.getElementById('timer').style.display = 'block';
            document.getElementById('timer').classList.remove('warning');

            clearInterval(timerInterval);
            initExam();
        }

        // Initialisation
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initExam);
        } else {
            initExam();
        }
    </script>
</body>
</html>
